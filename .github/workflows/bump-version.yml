name: Bump Version

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch to update (e.g., release-1.2)'
        required: true
        type: string
      version:
        description: 'Version to set (format: MAJOR.MINOR.PATCH, e.g., 8.4.8)'
        required: true
        type: string
      skip_nightly_check:
        description: 'Skip nightly build status check'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

jobs:
  validate-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION. Expected format: MAJOR.MINOR.PATCH"
            exit 1
          fi
          echo "Version format validated: $VERSION"

      - name: Check nightly build status on release branch
        if: ${{ !inputs.skip_nightly_check }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ inputs.release_branch }}"
          echo "Checking nightly build status for branch: $BRANCH"
          
          WORKFLOW_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/event-nightly.yml/runs?branch=$BRANCH&per_page=1" \
            --jq '.workflow_runs[0]')
          
          if [ -z "$WORKFLOW_RUNS" ] || [ "$WORKFLOW_RUNS" == "null" ]; then
            echo "::warning::No nightly workflow runs found for branch $BRANCH"
            exit 0
          fi
          
          STATUS=$(echo "$WORKFLOW_RUNS" | jq -r '.conclusion // "in_progress"')
          RUN_URL=$(echo "$WORKFLOW_RUNS" | jq -r '.html_url')
          
          echo "Latest nightly run: $RUN_URL"
          echo "Status: $STATUS"
          
          if [ "$STATUS" != "success" ]; then
            echo "::error::Latest nightly build did not succeed (status: $STATUS). Use 'skip_nightly_check' to override."
            exit 1
          fi
          
          echo "Nightly build passed!"

  bump-version:
    needs: validate-and-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4 // workdid

      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_branch }}
          path: release-branch // workdir/release-branch
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if tag already exists
        working-directory: release-branch
        run: |
          TAG="v${{ inputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists"
            exit 1
          fi
          echo "Tag $TAG does not exist, proceeding..."

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure Git
        working-directory: release-branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set version
        run: |
          python scripts/set_version.py "${{ inputs.version }}" --version-file release-branch/src/version.h

      - name: Commit version bump
        working-directory: release-branch
        run: |
          git add src/version.h
          git commit -m "bump version v${{ inputs.version }}"

      - name: Create annotated tag
        working-directory: release-branch
        run: |
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"

      - name: Push changes
        if: ${{ !inputs.dry_run }}
        working-directory: release-branch
        run: |
          git push origin ${{ inputs.release_branch }}
          git push origin "v${{ inputs.version }}"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        working-directory: release-branch
        run: |
          echo "::notice::DRY RUN - Changes were not pushed"
          echo "Would have pushed:"
          echo "  - Commit: bump version v${{ inputs.version }}"
          echo "  - Tag: v${{ inputs.version }}"
          git log -1 --oneline
          git tag -l "v${{ inputs.version }}"

      - name: Summary
        run: |
          echo "## Set Version Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Branch**: ${{ inputs.release_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered From**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Nightly Check Skipped**: ${{ inputs.skip_nightly_check }}" >> $GITHUB_STEP_SUMMARY

